import{b as y,d as O,t as T,c as H,ae,a6 as V,p as o,y as v,u as n,w as ve,ab as E,I as e,o as Q,a as x,Q as F,v as a,a9 as j,a$ as te,a0 as le,a7 as J,a8 as U,x as i,ac as xe,aO as be,B as $e,av as Ce,aa as z,T as Ve,ad as ee,_ as Qe,at as oe,af as Ue,Y as Ie,D as De}from"./index-Du_3Vesk.js";import{Q as L}from"./QSpace-k_Ok6dG2.js";import{Q as ye,a as q,d as Se,b as Me,c as ue}from"./QTable-BfwWHyg7.js";import{Q as G,_ as Ne}from"./CopyDownloadData.vue_vue_type_script_setup_true_lang-BEd0puie.js";import{Q as ge}from"./QTooltip-CsZJC6ig.js";import{a as $}from"./api-C-PlNVV_.js";import{J as je}from"./jsoneditor.min-DkeLFdXe.js";import{_ as A}from"./ButtonWithTooltip.vue_vue_type_script_setup_true_lang-GHMn38hu.js";import{d as Ae}from"./pinia-BXXl-SmG.js";import{_ as Y}from"./DateComponent.vue_vue_type_script_setup_true_lang-D3xsPFaU.js";import{Q as ie}from"./QItemLabel-CcbGqN9l.js";import{Q as de}from"./QItemSection-CpQhvstY.js";import{Q as re}from"./QItem-DtTTb-ec.js";import{Q as Oe}from"./QList-C_17cm5H.js";import{i as W,w as Te,a as Re}from"./utils-BH9nH3nv.js";import{a as B,H as X,V as ce,T as pe,S as me,A as fe}from"./apps-B1o9GbeE.js";import"./QChip-H_55yLGh.js";import"./format-CJebrXOQ.js";import"./selection-BDLl0KOp.js";import"./axios-CInKXjoT.js";import"./index-3fevySbJ.js";import"./auth-dzuJufgy.js";import"./i18n-CfPL3nQe.js";import"./marked.esm-CrmhQBcZ.js";import"./websocket-Cgz6NUB5.js";const Ee=Ae("users",()=>{const g=y({});async function d(t){t in g.value||(g.value[t]="",g.value[t]=(await $.get(`app_admin/user/${t}/name`)).data)}return{names:g,load:d}}),we=O({__name:"UserName",props:{id:{}},setup(g){const d=g,{id:t}=T(d),r=Ee(),m=H(()=>r.names[t.value]);return ae(async()=>{m.value===void 0&&r.load(t.value)}),(b,u)=>(o(),V("span",null,v(n(m)),1))}}),_e=O({__name:"DurationComponent",props:{time:{},start:{},end:{}},setup(g){const d=g,{time:t,start:r,end:m}=T(d),b=H(()=>{let u=t.value;if(["",null,void 0,NaN].includes(t.value)){if(["",null,void 0,NaN].includes(m.value))return"";u=m.value-r.value}if(u<1)return`${(1e3*u).toFixed(2)} ms`;if(u<60)return`${u.toFixed(2)} s`;const C=Math.floor(u/60),D=u%60;return`${C} m ${D.toFixed(2)} s`});return(u,C)=>v(n(b))}}),Fe=O({__name:"MemoryAmount",props:{memory:{}},setup(g){const d=g,{memory:t}=T(d),r=H(()=>["",null,void 0,NaN].includes(t.value)?"":t.value<1e5?t.value+" K":t.value<1e5*1024?Math.ceil(t.value/1024)+" M":Math.ceil(t.value/1024/1024)+" G");return(m,b)=>(o(),V("span",null,v(n(r)),1))}}),Be={style:{"text-indent":"0px","white-space":"pre-wrap"}},Z=O({__name:"LoadText",props:{tooltip:{default:""},title:{default:""},color:{default:void 0},url:{}},setup(g){const d=g,{url:t,tooltip:r,title:m,color:b}=T(d),u=y(!1),C=y("");return ve(()=>u.value,async()=>{if(u.value===!1)return;const D=await $.get(t.value);C.value=D.data}),(D,I)=>(o(),V(E,null,[e(F,{flat:"",dense:"",icon:"mdi-console",color:n(b),onClick:I[0]||(I[0]=N=>u.value=!0)},{default:a(()=>[e(ge,{bottom:""},{default:a(()=>[j(v(n(r)),1)]),_:1})]),_:1},8,["color"]),n(C)!==void 0?(o(),Q(te,{key:0,modelValue:n(u),"onUpdate:modelValue":I[2]||(I[2]=N=>le(u)?u.value=N:null)},{default:a(()=>[e(J,null,{default:a(()=>[e(U,null,{default:a(()=>[j(v(n(m)),1)]),_:1}),e(U,null,{default:a(()=>[i("p",Be,v(n(C)),1)]),_:1}),e(xe),e(be,null,{default:a(()=>[e(L),e(F,{color:"primary",text:"",onClick:I[1]||(I[1]=N=>u.value=!1)},{default:a(()=>I[3]||(I[3]=[j(" Close ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])):x("",!0)],64))}}),Je=O({__name:"LoadTexts",props:{jobId:{},showMessage:{type:Boolean,default:!1}},setup(g){const d=g,{jobId:t,showMessage:r}=T(d);return(m,b)=>(o(),V(E,null,[e(Z,{url:`job/${n(t)}/stdout`,tooltip:"Show Output",title:"Job output",color:"accent"},null,8,["url"]),e(Z,{url:`job/${n(t)}/stderr`,tooltip:"Show Errors",title:"Job error",color:"negative"},null,8,["url"]),n(r)?(o(),Q(Z,{key:0,url:`job/${n(t)}/message`,tooltip:"Show Message",title:"Report message",color:"warning"},null,8,["url"])):x("",!0)],64))}}),Le={key:6},Pe={key:8},qe={key:9},ze={key:10},He={key:11},Ke={key:12},Ge={key:13},Ye=O({__name:"JobsComponent",props:{appId:{},userId:{},fileId:{}},setup(g){const d=g,{appId:t,fileId:r,userId:m}=T(d),b=y(""),u=async()=>{if(r.value)return(await $.get(`/job/by_file/${r.value}`)).data;if(m.value)return(await $.get(`/job/by_user/${m.value}`)).data;if(t.value)return(await $.get(`/job/by_app/${t.value}`)).data},C=y([]),D=async()=>{C.value=await u()};ae(D);const I=_=>{if(_==="Done")return"bg-green-3";if(_==="Failed")return"bg-red-3";if(_==="Running")return"bg-yellow-3"},N=y(null),w={sortable:!0,align:"right"},M=[{...w,label:"ID",field:"id",name:"id"}];t.value===void 0&&M.push({...w,label:"App id",field:"app_id",name:"app_id"}),r.value===void 0&&M.push({...w,label:"File",field:"file_id",name:"file_id"}),m.value===void 0&&M.push({...w,label:"User",field:"user_id",name:"user_id"}),M.push({...w,label:"Status",field:"status",name:"status"},{...w,label:"Created",field:"created",name:"created",sortOrder:"da"},{...w,label:"Queue",field:"wait_time",name:"wait_time",sortOrder:"da"},{...w,label:"Calculation",field:"calculation_time",name:"calculation_time"},{...w,label:"Environment",field:"compute_env",name:"compute_env",sortOrder:"da"},{...w,label:"Function",field:"compute_func",name:"compute_func",sortOrder:"da"},{...w,label:"Used Memory",field:"mem_usage",name:"mem_usage"},{...w,label:"Options",field:"options",name:"options",width:"210px"}),$e(()=>{N.value.sort("created")});const S=async()=>{const _=await $.get("/admin/rq_url");window.open(_.data)};return(_,k)=>(o(),Q(J,{flat:""},{default:a(()=>[e(U,{class:"row"},{default:a(()=>[k[1]||(k[1]=i("div",{class:"text-h5 col"},"Jobs",-1)),e(L),e(A,{tooltip:"Refresh",icon:"mdi-refresh",color:"info",onClick:D}),e(A,{tooltip:"RQ Dashboard",icon:"mdi-rocket",color:"info",onClick:S})]),_:1}),e(U,null,{default:a(()=>[e(ye,{dense:"",ref_key:"table",ref:N,rows:n(C),pagination:{rowsPerPage:25},"hide-bottom":n(C).length<=25,filter:n(b),columns:M,"table-header-class":""},{top:a(()=>[k[2]||(k[2]=i("div",{class:"text-h6"},"Jobs",-1)),e(L),e(z,{borderless:"",dense:"",debounce:"300",color:"primary",modelValue:n(b),"onUpdate:modelValue":k[0]||(k[0]=c=>le(b)?b.value=c:null)},{append:a(()=>[e(Ve,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell":a(({row:c,col:h})=>[e(q,{class:Ce(I(c.status)+" text-right")},{default:a(()=>[h.name=="user_id"?(o(),Q(we,{key:0,id:c.user_id},null,8,["id"])):x("",!0),h.name=="created"?(o(),Q(Y,{key:1,date:c.created},null,8,["date"])):x("",!0),h.name=="started"?(o(),Q(Y,{key:2,date:c.started},null,8,["date"])):x("",!0),h.name=="finished"?(o(),Q(Y,{key:3,date:c.finished},null,8,["date"])):x("",!0),h.name=="wait_time"?(o(),Q(_e,{key:4,time:c.wait_time/1e3},null,8,["time"])):x("",!0),h.name=="calculation_time"?(o(),Q(_e,{key:5,time:c.calculation_time/1e3},null,8,["time"])):x("",!0),h.name=="status"?(o(),V("div",Le,v(c.status),1)):x("",!0),h.name=="mem_usage"?(o(),Q(Fe,{key:7,memory:c.mem_usage},null,8,["memory"])):x("",!0),h.name=="compute_env"?(o(),V("div",Pe,v(c.compute_env),1)):x("",!0),h.name=="compute_func"?(o(),V("div",qe,v(c.compute_func),1)):x("",!0),h.name=="id"?(o(),V("div",ze,v(c.id),1)):x("",!0),h.name=="file_id"?(o(),V("div",He,v(c.file_id),1)):x("",!0),h.name=="app_id"?(o(),V("div",Ke,v(c.app_id),1)):x("",!0),h.name=="options"&&!c.deleted?(o(),V("div",Ge,[e(Je,{jobId:c.id,showMessage:c.reported},null,8,["jobId","showMessage"])])):x("",!0)]),_:2},1032,["class"])]),_:1},8,["rows","hide-bottom","filter"])]),_:1})]),_:1}))}}),We=O({__name:"SearchUser",props:{open:{type:Boolean}},emits:["close"],setup(g,{emit:d}){const t=y(""),r=y([]),m=y(!1),b=y(null),u=g,{open:C}=T(u),D=async()=>{if(b.value=null,t.value.length>=4){const S=(await $.post(`/app_admin/search_user/?q=${t.value}`)).data;r.value=S,m.value=!0}else r.value=[],m.value=!1},I=y(null),N=S=>{b.value=S,t.value=S.name},w=d,M=S=>{w("close",S,b.value)};return ve(()=>C.value,async S=>{S&&(t.value="",r.value=[],m.value=!1)}),(S,_)=>(o(),Q(te,{"model-value":n(C),"onUpdate:modelValue":_[4]||(_[4]=k=>M(!1))},{default:a(()=>[e(J,null,{default:a(()=>[e(U,null,{default:a(()=>[e(z,{debounce:"200ms",autofocus:"",ref_key:"searchInput",ref:I,modelValue:t.value,"onUpdate:modelValue":[_[0]||(_[0]=k=>t.value=k),D],label:"Search for User",placeholder:"Enter at least 4 characters"},null,8,["modelValue"]),e(Se,{"no-focus":"",modelValue:m.value,"onUpdate:modelValue":_[1]||(_[1]=k=>m.value=k),"content-class":"menu-content",anchor:"top left",self:"bottom left"},{default:a(()=>[r.value.length>0?(o(),Q(Oe,{key:0,dense:"",bordered:"",separator:"",class:"menu-list"},{default:a(()=>[(o(!0),V(E,null,ee(r.value,k=>(o(),Q(re,{key:k.id,clickable:"",onClick:c=>N(k)},{default:a(()=>[e(de,null,{default:a(()=>[e(ie,null,{default:a(()=>[j(v(k.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})):(o(),Q(re,{key:1},{default:a(()=>[e(de,null,{default:a(()=>[e(ie,null,{default:a(()=>_[5]||(_[5]=[j("No users found")])),_:1})]),_:1})]),_:1}))]),_:1},8,["modelValue"])]),_:1}),e(be,{align:"right"},{default:a(()=>[e(F,{label:"Cancel",color:"negative",onClick:_[2]||(_[2]=k=>M(!1))}),e(F,{label:"OK",disabled:b.value==null,color:"secondary",onClick:_[3]||(_[3]=k=>M(!0))},null,8,["disabled"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Xe=Qe(We,[["__scopeId","data-v-d414f69a"]]),Ze={class:"row"},ea={class:"row"},aa={class:"bg-grey-4"},ta={style:{width:"300px"}},la={class:"text-h4 row"},na={class:"row"},Da=O({__name:"AppComponent",setup(g){const d=y({}),t=y({}),r=y([]),m=y([]),b=y(!1),u=H(()=>oe.currentRoute.value.query.appId),C=()=>Math.floor(new Date().getTime()/(1e3*60*60*24)),D=async()=>{const f=(await $.post("/app_admin/app_data",{app_id:u.value})).data;r.value=f.users,d.value=f.app;const s=C();for(let p of r.value)p.unlimited=p.expiry_date==0,p.unlimited||(p.expiry_date-=s);const l=(await $.post("/app_admin/files",{app_id:u.value})).data;t.value=[...l].sort((p,K)=>K.id-p.id),m.value=(await $.post("/get_app_python_packages_metadata",{app_id:u.value})).data},I=[{value:void 0,label:"Default"},{value:X,label:B[X]},{value:ce,label:B[ce]},{value:pe,label:B[pe]},{value:me,label:B[me]},{value:fe,label:B[fe]}],N=[{label:"Username",field:"name",name:"name",sortable:!0},{label:"Access",field:"access",name:"access",sortable:!0},{label:"Expires (in days)",field:"expiry_date",name:"expiry_date",align:"right",sortable:!0},{label:"Actions",field:"actions",name:"actions"}],w=async({name:f,id:s,access_level_v:l,expiry_date:p,unlimited:K},se=!1)=>{K?p=0:p+=C(),se&&(l=void 0),await $.post("/app_admin/set_app_access",{app_id:u.value,user_id:s,access_level_v:l,expiry_date:p}),W(`User ${f} ${se?"deleted":"updated"}`),D()},M=async(f,s)=>{if(b.value=!1,!f)return;if((await $.post("/app_admin/get_app_access",{user_id:s.id,app_id:u.value})).data!=null){Te("User already has access");return}await $.post("/app_admin/set_app_access",{app_id:u.value,user_id:s.id,access_level_v:X,expiry_date:C()-1}),W(`User ${s.name} added`),D()},S=async(f,s)=>{(s.ctrlKey||await Re("delete",`file ${f.id}`))&&(await $.file.delete(f.id),t.value=t.value.filter(l=>l.id!=f.id))},_=async()=>{Ie.create({title:"Delete all files",message:`Are you sure you want to delete ${Object.keys(t.value).length} files? This action cannot be undone.`,cancel:!0}).onOk(async()=>{for(const f of Object.values(t.value))await $.file.delete(f.id);t.value={}})},k=async()=>{await $.post("/app_admin/set_app_public",{app_id:u.value,public:!d.value.is_public}),d.value.is_public=!d.value.is_public},c=y(null),h=y(!1),R=y({}),P=y(null),ne=async()=>{const f=await $.get(`/model/${R.value.id}`);P.value.update(f.data)},ke=async f=>{R.value=f,h.value=!0,await De(),c.value.innerHTML="",P.value=new je(c.value,{mode:"view"}),ne()},he=async(f,s)=>{f.name!=s&&s.length!==0&&(await $.put(`/files/${f.id}`,{name:s}),f.name=s,W(`File ${f.id} renamed to ${s}`))};return ae(D),(f,s)=>(o(),V(E,null,[e(J,{flat:""},{default:a(()=>[e(U,{class:"text-h3 row"},{default:a(()=>[j(' Manage app "'+v(n(d).name)+'" (id: '+v(n(d).id)+") ",1)]),_:1}),e(U,{class:"text-h5 row q-py-none q-my-none"},{default:a(()=>[j(" Published: "+v(n(d).is_public?"Public":"Private")+" ",1),e(F,{label:n(d).is_public?"Unpublish":"Publish",onClick:k},null,8,["label"])]),_:1}),e(U,{class:"text-h5 row"},{default:a(()=>[s[2]||(s[2]=j(" Users with special access ")),e(L),e(A,{size:"md",label:"Add User",class:"bg-secondary text-white",onClick:s[0]||(s[0]=l=>b.value=!0)})]),_:1}),e(U,{class:"row justify-center"},{default:a(()=>[e(ye,{class:"col-auto",flat:"",rows:n(r),pagination:{rowsPerPage:10},"hide-bottom":n(r).length<=10,columns:N,"wrap-cells":""},{"body-cell-access":a(({row:l})=>[e(q,{class:"text-center"},{default:a(()=>[e(Me,{options:I,"map-options":"","emit-value":"",modelValue:l.access_level_v,"onUpdate:modelValue":[p=>l.access_level_v=p,()=>w(l)]},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),"body-cell-expiry_date":a(l=>[e(q,{props:l},{default:a(()=>[i("div",Ze,[e(z,{"input-class":"text-right",style:{width:"4em"},type:"number",debounce:"500",modelValue:l.row.expiry_date,"onUpdate:modelValue":[p=>l.row.expiry_date=p,()=>w(l.row)],modelModifiers:{number:!0}},null,8,["modelValue","onUpdate:modelValue"]),e(Ue,{label:"never",modelValue:l.row.unlimited,"onUpdate:modelValue":[p=>l.row.unlimited=p,()=>w(l.row)]},null,8,["modelValue","onUpdate:modelValue"])])]),_:2},1032,["props"])]),"body-cell-actions":a(l=>[e(q,{props:l},{default:a(()=>[i("div",ea,[e(A,{color:"negative",size:"md",icon:"delete",tooltip:"Remove access for user:"+(l.row.name?" "+l.row.name:""),onClick:p=>w(l.row,!0)},null,8,["tooltip","onClick"])])]),_:2},1032,["props"])]),_:1},8,["rows","hide-bottom"])]),_:1}),e(U,null,{default:a(()=>s[3]||(s[3]=[i("pre",null,`        Expires: days from today
        -1 = expired yesterday
        0 = expires today
        1 = expires tomorrow, etc.
      `,-1)])),_:1}),e(U,null,{default:a(()=>[e(G,{label:"Backend packages"},{default:a(()=>[e(ue,null,{default:a(()=>[s[4]||(s[4]=i("thead",null,[i("tr",null,[i("td",null,"Package"),i("td",null,"Size")])],-1)),i("tbody",null,[(o(!0),V(E,null,ee(n(m),l=>(o(),V("tr",{key:l.name},[i("td",null,v(l.name),1),i("td",null,v(Math.ceil(l.size/1024))+" kB",1)]))),128))])]),_:1})]),_:1})]),_:1}),e(U,null,{default:a(()=>[e(G,{label:"Files"},{default:a(()=>[e(ue,{class:"text-center"},{default:a(()=>[i("thead",aa,[i("tr",null,[s[5]||(s[5]=i("td",null,"Id",-1)),s[6]||(s[6]=i("td",null,"Filename",-1)),s[7]||(s[7]=i("td",null,"Owner",-1)),i("td",null,[Object.keys(n(t)).length>0?(o(),Q(A,{key:0,icon:"delete",color:"negative",tooltip:"Delete all files",onClick:_})):x("",!0)])])]),i("tbody",null,[(o(!0),V(E,null,ee(n(t),l=>(o(),V("tr",{key:l.id},[i("td",null,v(l.id),1),i("td",ta,[e(z,{borderless:"","model-value":l.name,"input-style":"text-align: center;",dense:"",debounce:"1000","onUpdate:modelValue":p=>he(l,p)},null,8,["model-value","onUpdate:modelValue"])]),i("td",null,[e(we,{id:l.user_id},null,8,["id"])]),i("td",null,[e(A,{icon:"edit",tooltip:"Edit simulation",onClick:p=>n(oe).push({path:"/app",query:{id:l.id,appId:n(d).id}})},null,8,["onClick"]),e(A,{icon:"mdi-database",tooltip:"Show raw data",onClick:p=>ke(l)},null,8,["onClick"]),e(A,{icon:"delete",color:"negative",tooltip:"Delete",onClick:p=>S(l,p)},null,8,["onClick"])])]))),128))])]),_:1})]),_:1})]),_:1}),e(U,null,{default:a(()=>[e(G,{label:"Jobs"},{default:a(()=>[e(Ye,{appId:n(u)},null,8,["appId"])]),_:1})]),_:1})]),_:1}),e(Xe,{open:n(b),onClose:M},null,8,["open"]),e(te,{modelValue:n(h),"onUpdate:modelValue":s[1]||(s[1]=l=>le(h)?h.value=l:null)},{default:a(()=>[e(J,{class:"full-width"},{default:a(()=>[e(U,null,{default:a(()=>[i("div",la,[j(v(n(R).name)+" ",1),e(L),n(P)?(o(),Q(Ne,{key:0,data:n(P).get(),filename:n(R).name,fileId:n(R).id},null,8,["data","filename","fileId"])):x("",!0),e(F,{color:"primary",flat:"",icon:"mdi-reload",onClick:ne},{default:a(()=>[e(ge,null,{default:a(()=>s[8]||(s[8]=[j(" Reload data ")])),_:1})]),_:1})]),i("div",na,"id: "+v(n(R).id),1)]),_:1}),e(U,{class:"full-width"},{default:a(()=>[i("div",{ref_key:"jsonEditorContainer",ref:c,class:"full-width"},null,512)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});export{Da as default};
