import{d as g}from"./pinia-BXXl-SmG.js";import{u as b}from"./auth-dzuJufgy.js";import{at as f,b as k,Y as v}from"./index-Du_3Vesk.js";const w='(function(){"use strict";console.log("hello from pyodide worker",self.location);const s={backend_url:"http://localhost:5001/api",have_backend:!0};s.have_backend=!1,s.backend_url=self.location.origin;const P="0.27.5",I=`https://cdn.jsdelivr.net/gh/mhochsteger/ngsolve_pyodide@${P}/snapshot.bin.gz`,T=`https://cdn.jsdelivr.net/gh/mhochsteger/ngsolve_pyodide@${P}/init.zip`,L=async()=>{const e=await(await fetch(I)).blob(),t=new DecompressionStream("gzip"),n=e.stream().pipeThrough(t);return await new Response(n).arrayBuffer()};async function R(e,t){const i=new TextEncoder().encode(t),c=await crypto.subtle.importKey("raw",i,{name:"PBKDF2"},!1,["deriveKey"]),r=await crypto.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},c,{name:"AES-CBC",length:256},!1,["decrypt"]),y=Uint8Array.from(atob(e),l=>l.charCodeAt(0)),h=y.slice(0,16),g=y.slice(16);return await crypto.subtle.decrypt({name:"AES-CBC",iv:h},r,g)}const z=performance.now(),B=["%cpython","color: blue"],M=["%cpython","color: red"];function A(e,t){const n=Math.round(performance.now()-z);console.log(...e,n,...t)}function o(...e){A(B,e)}function x(...e){A(M,e)}function k(...e){A(M,e)}let a=null;const m={},b={},u={};let w=null;const C={},d=e=>t=>{if(C[e])return C[e](w(t))},U=async e=>{const t=d("dialog"),n=await e.pop("onOk",null),i=await e.pop("onCancel",null),c=await t(e);n&&c.onOk(Comlink.proxy(()=>n())),i&&c.onCancel(Comlink.proxy(()=>i()))},f={};async function S(e,t){if(e in f)return f[e];const n={};if(t==null&&(s.have_backend?(t=`${s.backend_url}/pyodide/client_package/${e}`,n.Authorization=u.token,n["X-Client-Id"]=u.client_id):t=`${s.backend_url}/python_module/${e}`),o(`fetching ${e} from ${t}`),e in f)return f[e];const i=performance.now(),r=await(await fetch(t,{headers:n})).blob();return f[e]=await r.arrayBuffer(),o(`		fetch ${e}: ${Math.round(performance.now()-i)} ms`),f[e]}async function D(e,t=null,n=!1){if(e in m)return;o("fetch package",e,t,n);const i=await S(e,t);o("have package",e),n&&await _,o("have lock for package",e);const c=performance.now();e in m||(await a.unpackArchive(i,"wheel"),m[e]=!0,o(`		unpack ${e}: ${Math.round(performance.now()-c)} ms`))}async function N(e,t,n,i){postMessage(JSON.stringify({type:"callback",compId:e,callbackIndex:n,name:t,data:i}))}const E=[["webapp_client"],["webapp_api"],["webgpu"],["ngsolve_webgpu"]];async function J(){const e=await import("https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.mjs"),t=fetch(T);a=await e.loadPyodide({_loadSnapshot:await L(),stdout:o,stderr:k,args:[],lockFileURL:new URL(`pyodide-lock.json?version=${e.version}`,self.location.origin).href,indexURL:`https://cdn.jsdelivr.net/pyodide/v${P}/full/`}),a.runPython("import os"),a.setStdout({batched:o}),o("loaded pyodide",a);const n=await(await t).arrayBuffer();await a.unpackArchive(n,"zip",{extractDir:"/lib/python3.12/"}),o("unpacked init.zip"),w=a.runPython("import js, pyodide.ffi; lambda d: pyodide.ffi.to_js(d, dict_converter = js.Object.fromEntries)"),o("install packages",E),await Promise.all(E.map(i=>D(...i))),console.log("installed ready"),await a.registerJsModule("webapp_frontend",{dev:s.DEV,prod:s.PROD,backend_url:s.backend_url,log:o,warning:x,error:k,notify:d("notify"),dialog:U,reload:d("reload"),set_file_id:d("set_file_id"),copy_simulation:d("copy_simulation"),trace_event:d("trace_event"),run_js_callback:N,to_js:w}),o("registered webapp_frontend"),await a.runPythonAsync("import webgpu.platform"),o("imported webgpu.platform"),await a.runPython("import webapp_client.utils; webapp_client.utils.set_environment(webapp_client.utils.Environment.PYODIDE, True)")}const _=J(),K=async(e,t=!1)=>{const n=e.python_class.split(".")[0];o("package name",n),t&&(delete f[n],delete m[n]);const i=Promise.all(e.frontend_pip_dependencies.map(async l=>{await V(l)})),c=performance.now();let r=null;if(e.frontend_package)r=Uint8Array.from(atob(e.frontend_package),l=>l.charCodeAt(0));else if(s.have_backend){const l=`${s.backend_url}/get_app_frontend_package`;if(!u.token){const Y=W=>new Promise(Z=>setTimeout(Z,W));for(;!u.token;)await Y(100)}const j=u.token,X={Authorization:j,"X-Client-Id":u.client_id,"Content-Type":"application/json"},v=await(await fetch(l,{headers:X,body:JSON.stringify({app_id:e.id}),method:"POST"})).json();if(v.detail!==void 0&&v.detail.startsWith("<class "))throw new Error(v.detail+" Look at backend log for more details!");r=await R(v.data,j)}else{r=await S(n);for(const l of e.frontend_dependencies)await D(l)}const y=performance.now();o(`		fetch:	${Math.round(y-c)} ms`),f[n]=r;const h=performance.now();await _,await a.unpackArchive(r,"wheel");const g=performance.now();m[n]=!0,o(`		unpack:	${Math.round(h-y)} ms, ${Math.round(g-h)} ms`),await i},V=async e=>{e in b||(await _,!(e in b)&&await navigator.locks.request("pip_install",async()=>{if(e in b)return;o("install pip package",e);const t=performance.now();s.DEV&&d("setLoading")({value:!0,info:`Installing ${e}`}),await a.runPythonAsync(`import micropip; micropip.install(\'${e}\')`),b[e]=!0,o("done install pip package",e,`time: ${Math.round(performance.now()-t)} ms`)}))},q=async e=>{o("set auth data",e),u.token=e.token,u.client_id=e.client_id,await _,a.runPython(`from webapp_client.utils import get_environment; get_environment().set_backend(\'${s.backend_url}\', \'${e.token}\', \'${e.client_id}\');`)};async function F(e){k(e),d("setLoading")({value:!1});const t=`\n      <div>\n        <p>App could not be reloaded due to the following error:</p>\n        <pre style="background-color: #e0e0e0;">\n          ${e}\n        </pre>\n      </div>\n    `;await d("dialog")({type:"error",message:t,html:!0,ok:"Ok"})}let O={data:{},metadata:{}};async function H(e,t){o("pytohn loadModel",e,t),await _,o("install app",e),await K(e),o("load model",e);try{const i=await(await a.pyimport("webapp_client.app")).loadModel(a.toPy(e),a.toPy(t));o("model loaded"),O.data=t,O.metadata=t.metadata||{app_id:e.id};const r=await(await i.component)._get_my_wrapper_props();return o("app data in worker",r,w(r)),w(r)}catch(n){k("error in loadModel",n),F(n);return}}let p=null,$=null;self.onmessage=async e=>{if(e.data instanceof SharedArrayBuffer){$=e.data;return}const t=JSON.parse(e.data);if(t.type==="call"&&t.id==="setAuthData"){q(t.args[0]);return}if(p===null){await _;const i=(await a.pyimport("webgpu.link.base")).PyodideLink,c=new Int32Array($,0,1),r=new Uint8Array($,4);p=await i(self.postMessage,c,r),await(await a.pyimport("webgpu.platform")).init_pyodide(p),p.expose("get_component",(await a.pyimport("webapp_client.components")).get_component),p.expose("loadModel",async(h,g)=>await H(w(h),w(g)))}if(t.type==="call"&&t.id==="runAppCode"){try{const n=await a.runPythonAsync(t.args[0]);p.expose("app",n),p._send_response(t.request_id,a.toPy(n))}catch(n){console.error("Error in runAppCode",n);const i=a.toPy([n.toString()]);await p.call("showError",i)}return}await p._on_message_async(e.data)},_.then(()=>{self.postMessage("ready")})})();\n',y=typeof self!="undefined"&&self.Blob&&new Blob([w],{type:"text/javascript;charset=utf-8"});function A(n){let e;try{if(e=y&&(self.URL||self.webkitURL).createObjectURL(y),!e)throw"";const t=new Worker(e,{name:n==null?void 0:n.name});return t.addEventListener("error",()=>{(self.URL||self.webkitURL).revokeObjectURL(e)}),t}catch{return new Worker("data:text/javascript;charset=utf-8,"+encodeURIComponent(w),{name:n==null?void 0:n.name})}finally{e&&(self.URL||self.webkitURL).revokeObjectURL(e)}}function u(n){return n.preventDefault(),Object.fromEntries(["button","altKey","metaKey","ctrlKey","shiftKey","x","y","deltaX","deltaY","deltaMode","movementX","movementY"].map(t=>[t,n[t]]))}function P(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0)).buffer}function R(n){const e=new Uint8Array(n);let t="";for(let o=0;o<e.length;o++)t+=String.fromCharCode(e[o]);return btoa(t)}function m(n){return n===null||typeof n!="object"&&typeof n!="function"}function d(n){if(n===window||n===navigator||typeof n!="object"||n===null)return!1;if(Array.isArray(n))return n.every(d);if(n.$children||n.constructor!==Object)return!1;for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e)){const t=n[e];if(!m(t)&&!d(t))return!1}return!0}function j(n,e,t){const o=function(...a){return n.call(e,a,t)};o.handleEvent=async(a,i)=>n.callIgnoreResult(e,[a,i],t),o.callFunction=(a,i)=>n.call(e,[i],t),o.callMethod=async(a,i)=>await n.callMethod(e,a,[i]),o.callMethodIgnoreResult=(a,i)=>{n.callMethodIgnoreResult(e,a,i)};const r={get:function(a,i){return i==="_parent_id"?t:i==="_id"?e:i==="_link"?n:i==="handleEvent"?o.handleEvent:i==="call"?o.callFunction:i==="then"?Reflect.get(...arguments):i.startsWith("__")?Reflect.get(...arguments):i==="callMethodIgnoreResult"?Reflect.get(...arguments):i==="callMethod"?Reflect.get(...arguments):i==="_is_webapp_proxy"?!0:n.getProp(e,i)},set:function(a,i,s){return n.setProp(e,i,s),!0},apply:function(a,i,s){return n.call(e,s,t)}};return new Proxy(o,r)}class h{constructor(e){this.requestCounter=1,this.requests={},this.counter=1,this.objects={},this.connection=e,this.connection.onMessage(t=>this.onMessage(t)),this.connected=new Promise(t=>{this.connection.onOpen(()=>{this.expose("importPackage",window.importPackage),this.expose("addStyleFile",window.addStyleFile),console.log("connection open"),t()})})}async _sendRequestAwaitResponse(e){const t=this.requestCounter++;e.request_id=t;try{return await new Promise((r,a)=>{this.requests[t]=r,this.connection.send(e),setTimeout(()=>{a(new Error(`Timeout, request ${t}, data: ${JSON.stringify(e)}`))},2e4)})}finally{delete this.requests[t]}}async getProp(e,t){return await this._sendRequestAwaitResponse({type:"get",id:e,prop:t})}async getItem(e,t){return await this._sendRequestAwaitResponse({type:"get",id:e,key:t})}async setProp(e,t,o){this.connection.send({type:"set",id:e,prop:t,value:await this._dumpData(o)})}async setItem(e,t,o){this.connection.send({type:"set",id:e,key:t,value:await this._dumpData(o)})}async callIgnoreResult(e,t=[],o=void 0){return await this.connection.send({type:"call",id:e,parent_id:o,args:await this._dumpData(t)})}async call(e,t=[],o=void 0,r=void 0){return await this._sendRequestAwaitResponse({type:"call",id:e,parent_id:o,args:await this._dumpData(t),prop:r})}async callMethod(e,t,o=[]){return await this._sendRequestAwaitResponse({type:"call",id:e,args:await this._dumpData(o),prop:t})}async callMethodIgnoreResult(e,t,o=[]){return await this.connection.send({type:"call",id:e,args:await this._dumpData(o),prop:t})}expose(e,t){this.objects[e]=t}async _dumpData(e){if(e===null||e===void 0)return;if(e._is_webapp_proxy)return{type:"object",id:e._id};if(e instanceof MouseEvent||e instanceof Event||e instanceof InputEvent)return u(e);if(e instanceof ArrayBuffer)return{__is_crosslink_type__:!0,type:"bytes",value:R(e)};if(m(e))return e;if(e.constructor===Array){const o=[];for(let r of e)o.push(await this._dumpData(r));return o}if(e.__is_crosslink_type__||d(e))return e;if(e.constructor===Object){const o={};return await Promise.all(Object.keys(e).map(async r=>{o[r]=await this._dumpData(e[r])})),o}const t=this.counter++;return this.objects[t]=e,{__is_crosslink_type__:!0,type:"proxy",id:t}}_loadValue(e){if(e instanceof ArrayBuffer)return e;if(e!=null){if(!e.__is_crosslink_type__)return e;if(e.type=="bytes")return P(e.value);if(e.type=="object")return this.objects[e.id];if(e.type=="proxy")return j(this,e.id,e.parent_id);console.error("Cannot load value, unknown value type:",e)}}_loadData(e){return e==null||typeof e!="object"||e.__is_crosslink_type__?this._loadValue(e):(Object.keys(e).map(t=>{e[t]=this._loadData(e[t])}),e)}async sendResponse(e,t,o){if(t===void 0)return;const r=await this._dumpData(await Promise.resolve(e));this.connection.send({type:"response",request_id:t,value:r})}async onMessage(e){let t=e.data,o;e.data instanceof ArrayBuffer?(console.log("received binary data",e.data),o=new Uint32Array(e.data,0,1)[0],t={value:e.data.slice(4),type:"response"}):(t=JSON.parse(e.data),o=t.request_id);let r=t.id?this.objects[t.id]:window,a=null;switch(t.type){case"call":case"new":const i=this._loadData(t.args);let s=null;t.prop?(s=this.objects[t.id],r=s[t.prop]):s=this.objects[t.parent_id],t.type==="call"?a=r.apply(s,i):a=Reflect.construct(r,i);break;case"get_keys":a=Object.keys(r);break;case"get":t.prop?a=r[t.prop]:t.key?a=r[t.key]:a=r,a&&(t.prop||t.key)&&(a=await this._dumpData(a),typeof a=="object"&&(a.parent_id=t.id));break;case"set":const p=this._loadData(t.value);t.prop&&(r[t.prop]=p),t.key&&(r[t.key]=p);break;case"delete":this.objects[t.id]=void 0;break;case"response":this.requests[o](this._loadData(t.value));return;default:console.error("Unknown message type:",t,t.type)}o!==void 0&&t.type!=="response"&&(a=await a,t.result_callback?await this._loadData(t.result_callback)(a):this.sendResponse(a,o))}}function C(n){const e=new WebSocket(n);return e.binaryType="arraybuffer",new h({send:t=>e.send(JSON.stringify(t)),onMessage:t=>e.onmessage=t,onOpen:t=>e.onopen=t})}function M(n){const e=new SharedArrayBuffer(104857600),t=new Int32Array(e,0,1),o=new Uint8Array(e,4),r=new Promise(a=>{n.addEventListener("message",i=>{a()},{once:!0})});return new h({send:a=>{if(a.type==="response"){const i=JSON.stringify(a),s=new TextEncoder().encode(i);o.set(s),Atomics.store(t,0,s.length),Atomics.notify(t,0,1);return}n.postMessage(JSON.stringify(a))},onMessage:async a=>{await r,n.postMessage(e),n.addEventListener("message",a)},onOpen:async a=>{await r,a()}})}window.createLilGUI=async n=>{if(window.lil===void 0){const e="https://cdn.jsdelivr.net/npm/lil-gui@0.20";window.define===void 0?await import(e):await new Promise(async t=>{require([e],o=>{window.lil=o,t()})})}return new window.lil.GUI(n)};window.addStyleFile=async n=>{const e=document.createElement("link");e.rel="stylesheet",e.href=n,document.body.appendChild(e)};window.importPackage=async n=>window.define===void 0?await new Promise(async t=>{const o=document.createElement("script");o.src=n,o.onload=()=>{console.log("script loaded"),t()},document.body.appendChild(o)}):await new Promise(async t=>{require([n],o=>{t(o)})});window.patchedRequestAnimationFrame=(n,e,t)=>{requestAnimationFrame(o=>{const r=e.getCurrentTexture(),a=n.createCommandEncoder();a.copyTextureToTexture({texture:t},{texture:r},{width:r.width,height:r.height}),n.queue.submit([a.finish()])})};const O=g("remoteApp",()=>{b();let n=null;const e=f.currentRoute.value.query.websocketPort;e?n=C(`ws://localhost:${e}`):n=M(new A);const t=k(c=>{});return n.expose("router",f),n.expose("reloadApp",()=>{t.value()}),n.expose("showError",c=>{const l=`
      <div>
        <p>App could not be reloaded due to the following error:</p>
        <pre style="background-color: #e0e0e0;">
          ${c}
        </pre>
      </div>
    `;v.create({message:l,type:"error",html:!0,ok:"Ok",style:"min-width: 70vw;"})}),{getApp:async()=>(await n.connected,await n.getProp("app")),loadApp:async(c,l={})=>(await n.connected,await n.call("loadModel",[c,l])),getComponent:async c=>await(await n.getProp("get_component"))(c),setComponent:async(c,l)=>{n.objects["comp_"+c]=l},deleteComponent:async c=>{},runAppCode:async c=>(await n.connected,await n.call("runAppCode",[c])),onReload:t}});export{O as u};
